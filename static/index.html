<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[sorter]</title>
    <style>
        @font-face {
            font-family: 'Gerstner Programm';
            src: url('/static/Gerstner-Programm-Medium.otf') format('opentype');
            font-weight: 500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --text-main: #1B1D1E;
            --text-sub: #A2A2A2;
            --accent: #7B9FB5;
            --bg: #F8F8F8;
            --white: #FFFFFF;
            --border: #E0E0E0;
        }

        body {
            font-family: 'Gerstner Programm', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem 1.5rem;
        }

        .setup-panel {
            margin-top: 1rem;
            transition: all 0.2s ease;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .setup-panel.collapsed {
            padding: 0.75rem 1rem;
        }

        .setup-panel.collapsed .folder-inputs,
        .setup-panel.collapsed .load-btn {
            display: none;
        }

        .setup-header {
            display: none;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .setup-panel.collapsed .setup-header {
            display: flex;
        }

        .setup-header span {
            font-size: 0.75rem;
            color: var(--text-sub);
        }

        .expand-btn {
            font-size: 0.75rem;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .folder-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .folder-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .folder-group label {
            font-size: 0.75rem;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .folder-group .folder-select {
            display: flex;
            gap: 0.5rem;
        }

        .folder-group input {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 0.6rem 0.75rem;
            color: var(--text-main);
            font-family: inherit;
            font-size: 0.85rem;
            flex: 1;
        }

        .folder-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .browse-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 0.6rem 0.75rem;
            color: var(--text-main);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .browse-btn:hover {
            border-color: var(--accent);
        }

        .load-btn {
            background: var(--accent);
            border: none;
            border-radius: 2px;
            padding: 0.6rem 1.5rem;
            color: var(--white);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 1rem;
        }

        .load-btn:hover {
            opacity: 0.9;
        }

        .main-area {
            display: none;
            grid-template-columns: 220px 1fr;
            gap: 1rem;
            height: calc(100vh - 120px);
        }

        .main-area.active {
            display: grid;
        }

        .pdf-list {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1rem;
            overflow-y: auto;
            height: 100%;
        }

        .pdf-list h3 {
            font-size: 0.7rem;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            font-weight: 500;
        }

        .pdf-item {
            padding: 0.6rem 0.5rem;
            border-radius: 2px;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pdf-item:hover {
            background: var(--bg);
        }

        .pdf-item.active {
            background: var(--bg);
            border-left: 2px solid var(--accent);
            padding-left: calc(0.5rem - 2px);
        }

        .pdf-item.sorted {
            text-decoration: line-through;
            opacity: 0.85;
        }

        .pdf-item.sorted-1 {
            background: rgba(123, 159, 181, 0.25);
            border-left: 3px solid var(--accent);
            padding-left: calc(0.5rem - 3px);
        }

        .pdf-item.sorted-2 {
            background: rgba(27, 29, 30, 0.15);
            border-left: 3px solid var(--text-main);
            padding-left: calc(0.5rem - 3px);
        }

        .preview-area {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }

        .preview-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h2 {
            font-size: 0.85rem;
            font-weight: 500;
            max-width: 50%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .sort-btn {
            padding: 0.5rem 1.25rem;
            border: 1px solid var(--border);
            border-radius: 2px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--white);
            color: var(--text-main);
        }

        .sort-btn:hover {
            border-color: var(--accent);
        }

        .sort-btn.folder1 {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--white);
        }

        .sort-btn.folder2 {
            background: var(--text-main);
            border-color: var(--text-main);
            color: var(--white);
        }

        .undo-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 2px;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            background: var(--white);
            color: var(--text-sub);
        }

        .undo-btn:hover {
            border-color: var(--text-sub);
            color: var(--text-main);
        }

        .undo-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .preview-content {
            flex: 1;
            background: var(--bg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px;
        }

        .preview-content img {
            width: 100%;
            display: block;
        }


        .placeholder {
            color: var(--text-sub);
            text-align: center;
            font-size: 0.85rem;
        }

        .progress {
            text-align: center;
            padding: 1rem 0.5rem;
            color: var(--text-sub);
            font-size: 0.75rem;
            border-top: 1px solid var(--border);
            margin-top: 1rem;
        }

        .progress span {
            color: var(--accent);
            font-weight: 500;
        }

        @media (max-width: 900px) {
            .folder-inputs {
                grid-template-columns: 1fr;
            }
            .main-area {
                grid-template-columns: 1fr;
            }
            .pdf-list {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="setup-panel" id="setupPanel">
            <div class="setup-header" onclick="expandSetup()">
                <span id="collapsedInfo">Source → Folder 1 / Folder 2</span>
                <button class="expand-btn">Change folders</button>
            </div>
            <div class="folder-inputs">
                <div class="folder-group">
                    <label>Source Folder</label>
                    <div class="folder-select">
                        <input type="text" id="sourceFolder" placeholder="Select folder..." readonly>
                        <button class="browse-btn" onclick="pickFolder('source')">Browse</button>
                    </div>
                </div>
                <div class="folder-group">
                    <label>Folder 1</label>
                    <div class="folder-select">
                        <input type="text" id="destFolder1" placeholder="Select folder..." readonly>
                        <button class="browse-btn" onclick="pickFolder('dest1')">Browse</button>
                    </div>
                </div>
                <div class="folder-group">
                    <label>Folder 2</label>
                    <div class="folder-select">
                        <input type="text" id="destFolder2" placeholder="Select folder..." readonly>
                        <button class="browse-btn" onclick="pickFolder('dest2')">Browse</button>
                    </div>
                </div>
            </div>
            <button class="load-btn" onclick="loadPDFs()">Load</button>
        </div>

        <div class="main-area" id="mainArea">
            <div class="pdf-list">
                <h3>Files</h3>
                <div id="pdfListContent"></div>
                <div class="progress" id="progress"></div>
            </div>
            <div class="preview-area">
                <div class="preview-header">
                    <h2 id="currentFileName">Select a PDF</h2>
                    <div class="action-buttons">
                        <button class="undo-btn" id="undoBtn" onclick="undoLastMove()" disabled>Undo (Z)</button>
                        <button class="sort-btn folder1" id="folder1Btn" onclick="sortToFolder(1)">← Folder 1</button>
                        <button class="sort-btn folder2" id="folder2Btn" onclick="sortToFolder(2)">Folder 2 →</button>
                    </div>
                </div>
                <div class="preview-content" id="previewContent">
                    <div class="placeholder">Select a PDF from the list</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pdfs = [];
        let currentIndex = -1;
        let sortedCount = 0;
        let destFolder1 = '';
        let destFolder2 = '';
        let destFolder1Name = '';
        let destFolder2Name = '';
        let moveHistory = [];
        let previewCache = new Map();
        let allPagesCache = new Map();

        function getFolderName(path) {
            return path.split('/').filter(Boolean).pop() || path;
        }

        function getDisplayName(filename) {
            return filename.replace(/\.pdf$/i, '');
        }

        function expandSetup() {
            document.getElementById('setupPanel').classList.remove('collapsed');
        }

        function collapseSetup() {
            const srcName = getFolderName(document.getElementById('sourceFolder').value);
            document.getElementById('collapsedInfo').textContent = 
                `${srcName} → ${destFolder1Name} / ${destFolder2Name}`;
            document.getElementById('setupPanel').classList.add('collapsed');
        }

        async function pickFolder(target) {
            try {
                const res = await fetch('/api/pick-folder');
                const data = await res.json();
                
                if (data.path) {
                    if (target === 'source') {
                        document.getElementById('sourceFolder').value = data.path;
                    } else if (target === 'dest1') {
                        document.getElementById('destFolder1').value = data.path;
                    } else if (target === 'dest2') {
                        document.getElementById('destFolder2').value = data.path;
                    }
                }
            } catch (err) {
                alert('Error opening folder picker: ' + err.message);
            }
        }

        async function loadPDFs() {
            const sourceFolder = document.getElementById('sourceFolder').value.trim();
            destFolder1 = document.getElementById('destFolder1').value.trim();
            destFolder2 = document.getElementById('destFolder2').value.trim();

            if (!sourceFolder || !destFolder1 || !destFolder2) {
                alert('Please select all folders');
                return;
            }

            try {
                const [scanRes, val1Res, val2Res] = await Promise.all([
                    fetch('/api/scan-directory', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: sourceFolder })
                    }),
                    fetch('/api/validate-folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: destFolder1 })
                    }),
                    fetch('/api/validate-folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: destFolder2 })
                    })
                ]);

                if (!scanRes.ok) {
                    const err = await scanRes.json();
                    throw new Error(err.detail);
                }
                if (!val1Res.ok) {
                    const err = await val1Res.json();
                    throw new Error('Folder 1: ' + err.detail);
                }
                if (!val2Res.ok) {
                    const err = await val2Res.json();
                    throw new Error('Folder 2: ' + err.detail);
                }

                const scanData = await scanRes.json();
                const val1Data = await val1Res.json();
                const val2Data = await val2Res.json();

                destFolder1 = val1Data.path;
                destFolder2 = val2Data.path;
                destFolder1Name = getFolderName(destFolder1);
                destFolder2Name = getFolderName(destFolder2);

                document.getElementById('folder1Btn').textContent = `← ${destFolder1Name}`;
                document.getElementById('folder2Btn').textContent = `${destFolder2Name} →`;

                pdfs = scanData.pdfs;
                sortedCount = 0;
                moveHistory = [];
                updateUndoButton();

                if (pdfs.length === 0) {
                    alert('No PDFs found in the source folder');
                    return;
                }

                previewCache.clear();
                renderPDFList();
                document.getElementById('mainArea').classList.add('active');
                collapseSetup();
                
                if (pdfs.length > 0) {
                    for (let i = 0; i < Math.min(15, pdfs.length); i++) {
                        preloadPreview(pdfs[i].path);
                    }
                    selectPDF(0);
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function renderPDFList() {
            const container = document.getElementById('pdfListContent');
            container.innerHTML = pdfs.map((pdf, i) => {
                let classes = 'pdf-item';
                if (pdf.sorted) classes += ' sorted sorted-' + pdf.sortedTo;
                if (i === currentIndex) classes += ' active';
                const displayName = getDisplayName(pdf.name);
                return `<div class="${classes}" onclick="selectPDF(${i})" title="${displayName}">${displayName}</div>`;
            }).join('');
            updateProgress();
        }

        function updateProgress() {
            const remaining = pdfs.filter(p => !p.sorted).length;
            document.getElementById('progress').innerHTML = 
                `<span>${sortedCount}</span> sorted · ${remaining} remaining`;
        }

        function updateUndoButton() {
            const btn = document.getElementById('undoBtn');
            btn.disabled = moveHistory.length === 0;
        }

        async function selectPDF(index) {
            if (pdfs[index].sorted) return;
            
            currentIndex = index;
            const pdf = pdfs[index];
            
            document.getElementById('currentFileName').textContent = getDisplayName(pdf.name);
            
            const container = document.getElementById('previewContent');
            
            if (allPagesCache.has(pdf.path)) {
                renderAllPages(container, allPagesCache.get(pdf.path));
            } else {
                const previewSrc = previewCache.has(pdf.path) 
                    ? previewCache.get(pdf.path) 
                    : '/api/preview-image' + pdf.path;
                container.innerHTML = `<img src="${previewSrc}">`;
                
                loadAllPages(pdf.path, index);
            }
            
            renderPDFList();
            preloadNextPDFs();
        }

        function renderAllPages(container, pages) {
            container.innerHTML = pages.map((b64, i) => 
                `<img src="data:image/jpeg;base64,${b64}">`
            ).join('');
            container.scrollTop = 0;
        }

        async function loadAllPages(path, forIndex) {
            if (allPagesCache.has(path)) return;
            
            try {
                const res = await fetch('/api/all-pages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await res.json();
                allPagesCache.set(path, data.pages);
                
                if (currentIndex === forIndex) {
                    renderAllPages(document.getElementById('previewContent'), data.pages);
                }
            } catch (err) {
                console.error('Failed to load pages:', err);
            }
        }

        async function preloadPreview(path) {
            if (previewCache.has(path)) return;
            
            const img = new Image();
            img.src = '/api/preview-image' + path;
            img.onload = () => {
                previewCache.set(path, img.src);
            };
        }

        async function sortToFolder(folderNum) {
            if (currentIndex < 0) return;
            
            const pdf = pdfs[currentIndex];
            const destFolder = folderNum === 1 ? destFolder1 : destFolder2;

            try {
                const res = await fetch('/api/move-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: pdf.path,
                        destination_folder: destFolder
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }

                const result = await res.json();

                moveHistory.push({
                    index: currentIndex,
                    originalPath: pdf.path,
                    newPath: result.new_path,
                    folderNum: folderNum
                });
                updateUndoButton();

                pdfs[currentIndex].sorted = true;
                pdfs[currentIndex].sortedTo = folderNum;
                pdfs[currentIndex].currentPath = result.new_path;
                sortedCount++;

                const nextUnsorted = pdfs.findIndex((p, i) => i > currentIndex && !p.sorted);
                if (nextUnsorted >= 0) {
                    selectPDF(nextUnsorted);
                } else {
                    const anyUnsorted = pdfs.findIndex(p => !p.sorted);
                    if (anyUnsorted >= 0) {
                        selectPDF(anyUnsorted);
                    } else {
                        document.getElementById('currentFileName').textContent = 'Done';
                        document.getElementById('previewContent').innerHTML = 
                            '<div class="placeholder">All PDFs sorted</div>';
                        currentIndex = -1;
                    }
                }

                renderPDFList();
            } catch (err) {
                alert('Error moving file: ' + err.message);
            }
        }

        async function undoLastMove() {
            if (moveHistory.length === 0) return;

            const lastMove = moveHistory.pop();
            updateUndoButton();

            try {
                const res = await fetch('/api/move-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: lastMove.newPath,
                        destination_folder: lastMove.originalPath.substring(0, lastMove.originalPath.lastIndexOf('/'))
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail);
                }

                pdfs[lastMove.index].sorted = false;
                pdfs[lastMove.index].sortedTo = null;
                pdfs[lastMove.index].path = lastMove.originalPath;
                sortedCount--;

                selectPDF(lastMove.index);
                renderPDFList();
            } catch (err) {
                alert('Error undoing: ' + err.message);
                moveHistory.push(lastMove);
                updateUndoButton();
            }
        }

        function preloadNextPDFs() {
            let count = 0;
            for (let i = currentIndex + 1; i < pdfs.length && count < 5; i++) {
                if (!pdfs[i].sorted) {
                    if (!previewCache.has(pdfs[i].path)) {
                        preloadPreview(pdfs[i].path);
                    }
                    if (!allPagesCache.has(pdfs[i].path)) {
                        loadAllPages(pdfs[i].path, -1);
                    }
                    count++;
                }
            }
        }

        function goToPrevFile() {
            for (let i = currentIndex - 1; i >= 0; i--) {
                if (!pdfs[i].sorted) {
                    selectPDF(i);
                    return;
                }
            }
        }

        function goToNextFile() {
            for (let i = currentIndex + 1; i < pdfs.length; i++) {
                if (!pdfs[i].sorted) {
                    selectPDF(i);
                    return;
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                sortToFolder(1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                sortToFolder(2);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                goToPrevFile();
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                goToNextFile();
            } else if (e.key === 'z' || e.key === 'Z') {
                undoLastMove();
            }
        });
    </script>
</body>
</html>
